<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Focus Intervention — Planner, Tasks & Activity</title>

  <!-- PWA-friendly metas -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#0ea5e9">

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            brand: {
              50:'#ecfeff',100:'#cffafe',200:'#a5f3fc',300:'#67e8f9',400:'#22d3ee',
              500:'#06b6d4',600:'#0891b2',700:'#0e7490',800:'#155e75',900:'#164e63'
            }
          },
          boxShadow: {
            soft: '0 8px 24px rgba(2, 6, 23, 0.08)'
          }
        }
      }
    }
  </script>

  <style>
    .no-select { user-select: none; -webkit-user-select: none; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl font-bold tracking-tight text-brand-700">Focus Intervention</h1>
      <nav class="flex items-center gap-2 text-sm">
        <button class="tab-btn px-3 py-1.5 rounded-lg hover:bg-gray-100" data-tab-target="activity">Activity</button>
        <button class="tab-btn px-3 py-1.5 rounded-lg hover:bg-gray-100" data-tab-target="planner">Day Planner</button>
        <button class="tab-btn px-3 py-1.5 rounded-lg hover:bg-gray-100" data-tab-target="tasks">Tasks</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-8">

    <!-- ACTIVITY TAB -->
    <section id="tab-activity" data-tab-panel class="space-y-4">
      <!-- Focus Timer card -->
      <div class="rounded-2xl p-4 bg-white border shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold text-slate-800">Focus Timer</h2>
          <span class="text-xs text-gray-500">Drift-free (wall-clock)</span>
        </div>
        <div id="focus-display" class="text-4xl font-mono tracking-widest my-3">00:00:00</div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="focus-start" class="px-3 py-1.5 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Start</button>
          <button id="focus-pause" class="px-3 py-1.5 rounded-lg bg-amber-500 text-white hover:bg-amber-600">Pause</button>
          <button id="focus-reset" class="px-3 py-1.5 rounded-lg bg-rose-600 text-white hover:bg-rose-700">Reset</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">Sessions are logged when you pause/reset (≥ 1 min).</p>
      </div>

      <!-- Activity: Productivity Summary -->
      <section id="productivity">
        <div class="rounded-2xl p-4 bg-gradient-to-r from-sky-500/10 via-cyan-500/10 to-fuchsia-500/10 border border-sky-200/60">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-lg font-bold text-sky-700">Productivity Summary</h2>
            <span id="prod-trend-badge" class="text-xs px-2 py-1 rounded-full bg-emerald-100 text-emerald-700 font-semibold">+0%</span>
          </div>

          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <div class="rounded-xl p-3 bg-white border">
              <div class="text-xs text-gray-500">Tasks (via app)</div>
              <div id="prod-tasks-completed" class="text-2xl font-bold">0</div>
            </div>
            <div class="rounded-xl p-3 bg-white border">
              <div class="text-xs text-gray-500">Focus Hours</div>
              <div id="prod-focus-hours" class="text-2xl font-bold">0.0</div>
            </div>
            <div class="rounded-xl p-3 bg-white border">
              <div class="text-xs text-gray-500">Sessions</div>
              <div id="prod-sessions" class="text-2xl font-bold">0</div>
            </div>
            <div class="rounded-xl p-3 bg-white border">
              <div class="text-xs text-gray-500">This Week Streak</div>
              <div id="prod-streak" class="text-2xl font-bold">0</div>
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between text-sm mb-1">
              <span class="font-medium text-gray-700">Progress vs last week</span>
              <span id="prod-trend" class="text-gray-600">0%</span>
            </div>
            <div class="h-2 w-full bg-gray-100 rounded-full overflow-hidden">
              <div id="prod-progress-bar" class="h-2 w-0 bg-gradient-to-r from-sky-500 via-cyan-500 to-fuchsia-500 transition-[width] duration-700"></div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- DAY PLANNER TAB -->
    <section id="tab-planner" data-tab-panel class="hidden">
      <div class="rounded-2xl p-4 bg-gradient-to-r from-indigo-500/10 via-violet-500/10 to-fuchsia-500/10 border border-indigo-200/60">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold text-indigo-700">Day Planner</h2>
          <span id="planner-day" class="text-xs px-2 py-1 rounded-full bg-indigo-100 text-indigo-700 font-semibold">Today</span>
        </div>

        <!-- Replace this scaffolding with your existing planner content if you have it -->
        <div id="planner-grid" class="grid md:grid-cols-2 gap-3 no-select">
          <div class="rounded-xl p-3 bg-white border">
            <h3 class="font-semibold mb-1">Morning</h3>
            <ul id="planner-morning" class="text-sm text-gray-700 space-y-1"></ul>
          </div>
          <div class="rounded-xl p-3 bg-white border">
            <h3 class="font-semibold mb-1">Afternoon</h3>
            <ul id="planner-afternoon" class="text-sm text-gray-700 space-y-1"></ul>
          </div>
          <div class="rounded-xl p-3 bg-white border md:col-span-2">
            <h3 class="font-semibold mb-1">Evening</h3>
            <ul id="planner-evening" class="text-sm text-gray-700 space-y-1"></ul>
          </div>
        </div>
      </div>
    </section>

    <!-- TASKS TAB -->
    <section id="tab-tasks" data-tab-panel class="hidden space-y-4">
      <div class="rounded-2xl p-4 bg-white border shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-bold">Tasks</h2>
          <div class="flex items-center gap-2">
            <input id="new-task-title" class="border rounded-lg px-3 py-1.5 text-sm" placeholder="Add a task & press Enter" />
          </div>
        </div>
        <ul id="task-list" class="mt-3 divide-y">
          <!-- active tasks populate here -->
        </ul>
      </div>

      <!-- Completed This Week -->
      <section id="weekly-tasks">
        <div class="rounded-2xl p-4 bg-gradient-to-r from-emerald-500/10 via-teal-500/10 to-sky-500/10 border border-emerald-200/60">
          <h2 class="text-lg font-bold text-emerald-700 mb-2">Tasks Completed This Week</h2>
          <ul id="weekly-completed-list" class="list-disc list-inside text-sm text-gray-800 space-y-1">
            <!-- populated by JS -->
          </ul>
        </div>
      </section>
    </section>

  </main>

  <!-- Footer -->
  <footer class="border-t">
    <div class="max-w-6xl mx-auto px-4 py-4 text-xs text-gray-500">
      <span>© <span id="year"></span> Focus Intervention</span>
    </div>
  </footer>

  <script>
    // ---------------------------
    // CONFIG / HOOKS
    // ---------------------------
    const HOOKS = {
      tabs: {
        activityBtn: '[data-tab-target="activity"]',
        plannerBtn:  '[data-tab-target="planner"]',
        tasksBtn:    '[data-tab-target="tasks"]',
        activity:    '#tab-activity',
        planner:     '#tab-planner',
        tasks:       '#tab-tasks'
      },
      storage: {
        tasks: 'fi_tasks',
        focusSessions: 'fi_focus_sessions',
        timer: 'fi_focus_timer_v1'
      }
    };

    // Your Todoist iCal proxy (Cloudflare Worker)
    const TODOIST_ICS_PROXY = 'https://fi-todoist-ical-proxy.mbps.workers.dev';

    // ---------------------------
    // TAB ROUTER
    // ---------------------------
    (function Tabs() {
      function show(id) {
        document.querySelectorAll('[data-tab-panel]').forEach(p => p.classList.add('hidden'));
        const el = document.querySelector(id);
        if (el) el.classList.remove('hidden');
        if (id === HOOKS.tabs.activity) updateProductivity();
        if (id === HOOKS.tabs.tasks) renderWeeklyCompletedTasks();
      }
      document.addEventListener('click', (e) => {
        const t = e.target.closest('.tab-btn');
        if (!t) return;
        const target = t.getAttribute('data-tab-target');
        if (target === 'activity') show(HOOKS.tabs.activity);
        if (target === 'planner')  show(HOOKS.tabs.planner);
        if (target === 'tasks')    show(HOOKS.tabs.tasks);
      });
      document.addEventListener('DOMContentLoaded', () => show(HOOKS.tabs.activity));
    })();

    // ---------------------------
    // STORAGE & TASK HELPERS
    // ---------------------------
    function loadJSON(key, fallback) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch { return fallback; } }
    function saveJSON(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch {} }

    function getAllTasks() { return loadJSON(HOOKS.storage.tasks, []); }
    function setAllTasks(tasks) { saveJSON(HOOKS.storage.tasks, tasks); }

    function addTask(title) {
      const tasks = getAllTasks();
      const t = { id: crypto.randomUUID(), title, createdAt: new Date().toISOString(), completedAt: null, completedViaApp: true };
      tasks.unshift(t);
      setAllTasks(tasks);
      renderTasks();
      updateProductivity();
      return t;
    }
    function toggleTask(id) {
      const tasks = getAllTasks();
      const t = tasks.find(x => x.id === id);
      if (!t) return;
      if (t.completedAt) {
        t.completedAt = null;
      } else {
        t.completedAt = new Date().toISOString();
        t.completedViaApp = true;
      }
      setAllTasks(tasks);
      renderTasks();
      updateProductivity();
      renderWeeklyCompletedTasks();
    }
    function getCompletedTasks() { return getAllTasks().filter(t => t.completedAt); }
    function getCompletedTasksWithinDays(days=7) {
      const since = Date.now() - days*24*60*60*1000;
      return getCompletedTasks().filter(t => (new Date(t.completedAt).getTime() >= since));
    }
    function formatDate(iso) {
      const d = new Date(iso);
      return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
    }

    function renderTasks() {
      const list = document.getElementById('task-list');
      if (!list) return;
      const tasks = getAllTasks();
      list.innerHTML = '';
      tasks.forEach(t => {
        const li = document.createElement('li');
        li.className = 'py-2 flex items-start gap-3';
        li.innerHTML = `
          <input type="checkbox" class="mt-1 h-4 w-4" ${t.completedAt ? 'checked' : ''} data-task="${t.id}">
          <div class="flex-1">
            <div class="text-sm ${t.completedAt ? 'line-through text-gray-400' : 'text-gray-800'}">${t.title}</div>
            <div class="text-[11px] text-gray-500">${t.completedAt ? 'Completed ' + formatDate(t.completedAt) : 'Created ' + formatDate(t.createdAt)}</div>
          </div>
        `;
        list.appendChild(li);
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.target && e.target.id === 'new-task-title' && e.key === 'Enter') {
        const v = e.target.value.trim();
        if (v) { addTask(v); e.target.value = ''; }
      }
    });
    document.addEventListener('change', (e) => {
      const id = e.target && e.target.getAttribute && e.target.getAttribute('data-task');
      if (id) toggleTask(id);
    });

    // ---------------------------
    // FOCUS SESSIONS
    // ---------------------------
    function getFocusSessions() { return loadJSON(HOOKS.storage.focusSessions, []); }
    function setFocusSessions(arr) { saveJSON(HOOKS.storage.focusSessions, arr); }
    function logFocusSession(startISO, endISO) {
      const durationMs = new Date(endISO) - new Date(startISO);
      if (durationMs <= 0) return;
      const sessions = getFocusSessions();
      sessions.push({ start: startISO, end: endISO, durationMs });
      setFocusSessions(sessions);
    }
    function getFocusSessionsWithinDays(days=7) {
      const since = Date.now() - days*24*60*60*1000;
      return getFocusSessions().filter(s => new Date(s.start).getTime() >= since);
    }
    function getFocusHoursThisWeek() {
      const sessions = getFocusSessionsWithinDays(7);
      const totalMs = sessions.reduce((a, s) => a + (s.durationMs || 0), 0);
      return totalMs / 3600000;
    }

    // ---------------------------
    // PRODUCTIVITY RENDER
    // ---------------------------
    function updateProductivity() {
      const tasks = getCompletedTasksWithinDays(7);
      const tasksViaApp = tasks.filter(t => t.completedViaApp !== false);
      const sessions = getFocusSessionsWithinDays(7);
      const hours = getFocusHoursThisWeek();

      const elTasks = document.getElementById('prod-tasks-completed');
      const elHours = document.getElementById('prod-focus-hours');
      const elSessions = document.getElementById('prod-sessions');
      const elStreak = document.getElementById('prod-streak');
      const elTrend = document.getElementById('prod-trend');
      const elBadge = document.getElementById('prod-trend-badge');
      const elBar = document.getElementById('prod-progress-bar');

      if (elTasks) elTasks.textContent = String(tasksViaApp.length);
      if (elHours) elHours.textContent = hours.toFixed(1);
      if (elSessions) elSessions.textContent = String(sessions.length);

      const byDay = new Map();
      for (const s of sessions) {
        const k = new Date(s.start).toDateString();
        byDay.set(k, (byDay.get(k) || 0) + (s.durationMs || 0));
      }
      const streak = Array.from(byDay.values()).filter(ms => ms >= 25*60*1000).length;
      if (elStreak) elStreak.textContent = String(streak);

      const now = Date.now();
      const prevStart = now - 14*24*60*60*1000;
      const prevEnd   = now - 7*24*60*60*1000;
      const prev = getFocusSessions().filter(s => {
        const ts = new Date(s.start).getTime();
        return ts >= prevStart && ts < prevEnd;
      });
      const prevMs = prev.reduce((a, s) => a + (s.durationMs || 0), 0);
      const prevH = prevMs / 3600000;

      const delta = (hours - prevH);
      const pct = prevH > 0 ? Math.round((delta / prevH) * 100) : (hours > 0 ? 100 : 0);
      const pctLabel = (pct >= 0 ? `+${pct}` : `${pct}`) + '%';

      if (elTrend) elTrend.textContent = pctLabel;
      if (elBadge) {
        elBadge.textContent = pctLabel;
        elBadge.className = 'text-xs px-2 py-1 rounded-full font-semibold ' + (pct >= 0 ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700');
      }
      if (elBar) {
        const goal = 10; // hours/week
        const w = Math.max(0, Math.min(100, Math.round((hours/goal)*100)));
        elBar.style.width = w + '%';
      }
    }

    function renderWeeklyCompletedTasks() {
      const list = document.getElementById('weekly-completed-list');
      if (!list) return;
      list.innerHTML = '';
      const tasks = getCompletedTasksWithinDays(7).sort((a,b)=> new Date(b.completedAt)-new Date(a.completedAt));
      if (!tasks.length) {
        list.innerHTML = '<li>No tasks completed this week</li>';
        return;
      }
      for (const t of tasks) {
        const li = document.createElement('li');
        li.textContent = `${t.title} (✔ ${formatDate(t.completedAt)})`;
        list.appendChild(li);
      }
    }

    // ---------------------------
    // DRIFT-FREE FOCUS TIMER
    // ---------------------------
    (function FocusTimerModule() {
      const DISPLAY_ID = 'focus-display';
      const BTN_START = 'focus-start';
      const BTN_PAUSE = 'focus-pause';
      const BTN_RESET = 'focus-reset';
      const STORAGE_KEY = HOOKS.storage.timer;

      let baseElapsedMs = 0;
      let startWallClock = null;
      let rafId = null;
      let runStartISO = null;

      const $display = () => document.getElementById(DISPLAY_ID);
      const msNow = () => Date.now();

      const fmt = (ms) => {
        const s = Math.floor(ms / 1000);
        const hh = String(Math.floor(s / 3600)).padStart(2,'0');
        const mm = String(Math.floor((s % 3600) / 60)).padStart(2,'0');
        const ss = String(s % 60).padStart(2,'0');
        return `${hh}:${mm}:${ss}`;
      };

      const currentElapsedMs = () => (startWallClock != null ? (baseElapsedMs + (msNow() - startWallClock)) : baseElapsedMs);

      function render() { const d = $display(); if (d) d.textContent = fmt(currentElapsedMs()); }
      function loop() { render(); rafId = window.requestAnimationFrame(loop); }

      function start() {
        if (startWallClock != null) return;
        startWallClock = msNow();
        if (!runStartISO) runStartISO = new Date().toISOString();
        save();
        if (!rafId) rafId = window.requestAnimationFrame(loop);
      }

      function pause() {
        if (startWallClock == null) return;
        baseElapsedMs += msNow() - startWallClock;
        startWallClock = null;
        const elapsedNow = currentElapsedMs();
        if (runStartISO && elapsedNow >= 60*1000) {
          logFocusSession(runStartISO, new Date().toISOString());
        }
        runStartISO = null;
        save();
        updateProductivity();
      }

      function reset() {
        if (startWallClock != null) pause();
        baseElapsedMs = 0;
        startWallClock = null;
        runStartISO = null;
        save();
        render();
      }

      function save() {
        const payload = { baseElapsedMs, startWallClock, savedAt: msNow() };
        saveJSON(STORAGE_KEY, payload);
      }

      function restore() {
        const s = loadJSON(STORAGE_KEY, null);
        if (!s) return render();
        baseElapsedMs = Number(s.baseElapsedMs || 0);
        if (s.startWallClock != null) {
          const delta = msNow() - Number(s.savedAt || s.startWallClock);
          startWallClock = msNow() - delta;
          if (!rafId) rafId = window.requestAnimationFrame(loop);
        }
        render();
      }

      document.addEventListener('visibilitychange', () => { if (!document.hidden) render(); });
      document.addEventListener('click', (e) => {
        const id = e.target && e.target.id;
        if (id === BTN_START) start();
        if (id === BTN_PAUSE) pause();
        if (id === BTN_RESET) reset();
      });
      window.addEventListener('beforeunload', save);
      document.addEventListener('DOMContentLoaded', () => { restore(); render(); });
    })();

    // ---------------------------
    // TODOIST ICAL SYNC (via Cloudflare Worker)
    // ---------------------------
    async function fetchTodoistICS() {
      const r = await fetch(TODOIST_ICS_PROXY, { cache: 'no-store' });
      if (!r.ok) throw new Error('ICS fetch failed: ' + r.status);
      return await r.text();
    }

    function parseICS(icsText) {
      const lines = icsText.replace(/\r\n/g, '\n').split('\n');
      const events = [];
      let cur = null;
      const commit = () => { if (cur) { events.push(cur); cur = null; } };

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        if (line.startsWith('BEGIN:VEVENT')) { cur = { raw: {} }; continue; }
        if (line.startsWith('END:VEVENT'))   { commit(); continue; }
        if (!cur) continue;
        while (i + 1 < lines.length && (lines[i+1].startsWith(' ') || lines[i+1].startsWith('\t'))) {
          line += lines[++i].slice(1);
        }
        const idx = line.indexOf(':'); if (idx === -1) continue;
        const keyPart = line.slice(0, idx);
        const val = line.slice(idx + 1);
        const key = keyPart.split(';')[0].toUpperCase();
        cur.raw[key] = val;
      }

      const mapDT = (s) => {
        if (!s) return null;
        if (s.length === 8) {
          const y = +s.slice(0,4), m = +s.slice(4,6)-1, d = +s.slice(6,8);
          return new Date(Date.UTC(y, m, d));
        }
        return new Date(s.endsWith('Z') ? s : (s + 'Z'));
      };

      return events.map(e => {
        const uid = (e.raw.UID || `${e.raw.DTSTART || ''}-${e.raw.SUMMARY || ''}`).trim();
        const summary = (e.raw.SUMMARY || '').trim() || '(untitled)';
        const dtstart = (e.raw.DTSTART || '').trim();
        const dtend   = (e.raw.DTEND   || '').trim();
        return {
          id: String(uid),
          title: summary,
          start: mapDT(dtstart),
          end:   mapDT(dtend),
          allDay: dtstart.length === 8
        };
      }).filter(e => e.start);
    }

    async function syncFromTodoistICS() {
      try {
        const ics = await fetchTodoistICS();
        const events = parseICS(ics);

        const now = Date.now();
        const minTs = now - 7 * 864e5;
        const maxTs = now + 30 * 864e5;
        const filtered = events.filter(e => {
          const ts = e.start?.getTime() || 0;
          return ts >= minTs && ts <= maxTs;
        });

        const mapped = filtered.map(e => ({
          id: e.id,
          title: e.title,
          createdAt: (e.start || new Date()).toISOString(),
          dueAt: e.start ? e.start.toISOString() : null,
          completedAt: null,
          completedViaApp: false,
          source: 'todoist-ical'
        }));

        const existing = getAllTasks();
        const byId = new Map(existing.map(t => [String(t.id), t]));
        for (const m of mapped) {
          const prev = byId.get(m.id);
          byId.set(m.id, { ...m, completedAt: prev?.completedAt ?? null });
        }

        setAllTasks(Array.from(byId.values()));
        renderTasks();
        renderWeeklyCompletedTasks();
        updateProductivity();
      } catch (err) {
        console.warn('Todoist iCal sync failed:', err);
      }
    }

    // ---------------------------
    // BOOT
    // ---------------------------
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('year').textContent = new Date().getFullYear();
      renderTasks();
      updateProductivity();
      renderWeeklyCompletedTasks();

      // Keep desktop & mobile current
      syncFromTodoistICS();
      window.addEventListener('focus', syncFromTodoistICS);
      document.addEventListener('visibilitychange', () => { if (!document.hidden) syncFromTodoistICS(); });
      window.addEventListener('online', syncFromTodoistICS);
      setInterval(syncFromTodoistICS, 5 * 60 * 1000);
    });
  </script>

  <!-- (Optional) SW register; keep your own filename if different -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</body>
</html>
