<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Focus Intervention</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192.png" />
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />

  <style>
    :root{
      --bg:#0f172a; --bg-2:#111827; --card:#162238; --muted:#94a3b8; --brand:#3b82f6; --brand-2:#1d4ed8;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:#334155;
      --radius:14px; --space:16px; --tap:44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:linear-gradient(135deg, #0f172a, #1e293b); color:#fff;
      -webkit-tap-highlight-color: transparent;
    }

    /* Layout */
    .app{min-height:100%; display:flex; flex-direction:column; padding-bottom: calc(56px + env(safe-area-inset-bottom));}
    header{
      position:sticky; top:0; z-index:5;
      background:rgba(15,23,42,.85); backdrop-filter: blur(8px);
      padding: max(12px, env(safe-area-inset-top)) var(--space) 10px;
      border-bottom:1px solid #1f2a44;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px; height:10px; border-radius:50%; background:var(--danger); box-shadow:0 0 0 0 rgba(16,185,129,.4); transition:.3s}
    .dot.active{background:var(--ok); animation:pulse 2s infinite}
    .hdr-right{margin-left:auto; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}

    .content{flex:1; padding:12px var(--space); max-width:1000px; width:100%; margin:0 auto}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){
      .grid{grid-template-columns: 1.1fr .9fr}
      .section{min-height:520px}
    }

    .section{
      background:rgba(15,23,42,.6); border:1px solid var(--ring);
      border-radius:var(--radius); padding:12px;
    }
    .section h2{margin:0 0 10px; font-size:1.05rem}

    /* Tabs (mobile) */
    .tabs{display:none}
    .tabbar{
      position:fixed; bottom:0; left:0; right:0; z-index:9;
      background:rgba(15,23,42,.96); backdrop-filter: blur(8px);
      border-top:1px solid #1f2a44; height:56px; padding:6px max(10px, env(safe-area-inset-left)) max(6px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-right));
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    }
    .tabbtn{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-height:44px; border-radius:12px; color:#cbd5e1; border:1px solid transparent; font-size:11px;
    }
    .tabbtn.active{color:#fff; border-color:#28406d; background:#12203a}
    .hide-mobile{display:none}
    @media(min-width:900px){
      .tabbar{display:none}
      .tabs{display:none}
      .hide-mobile{display:block}
    }

    /* Controls */
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; min-height:var(--tap); border-radius:10px; border:1px solid #2a3a57; background:linear-gradient(135deg,#28406d,#1b2e52); color:#fff; cursor:pointer; font-weight:600}
    .btn:active{transform: translateY(1px)}
    .btn.ok{background:linear-gradient(135deg,#16a34a,#0f7a3a); border-color:#0f7a3a}
    .btn.warn{background:linear-gradient(135deg,#f59e0b,#b45309); border-color:#b45309}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c); border-color:#b91c1c}
    .btn.ghost{background:transparent}

    .row{display:flex; gap:8px; flex-wrap:wrap}

    /* Matrix (accordion on mobile) */
    .matrix{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:899px){ .matrix{grid-template-columns:1fr} }
    .quad{padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,.15); cursor:pointer}
    .q1{background:linear-gradient(135deg,#b91c1c,#ef4444)}
    .q2{background:linear-gradient(135deg,#059669,#10b981)}
    .q3{background:linear-gradient(135deg,#d97706,#f59e0b)}
    .q4{background:linear-gradient(135deg,#6366f1,#4338ca)}
    .quad h3{margin:0 0 6px; font-size:1rem}
    .quad p{margin:0; opacity:.9; font-size:.9rem}

    /* Tasks */
    .task-add{display:flex; gap:8px; margin:10px 0}
    .input{
      flex:1; padding:12px; min-height:var(--tap); border-radius:10px; border:1px solid #2a3a57; background:#111c30; color:#fff; font-size:16px;
    }
    .tasklist{display:grid; gap:8px; max-height:360px; overflow:auto; padding-right:2px}
    .task{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid #263754; background:#0f1a30; border-radius:10px}
    .task .title{flex:1}
    .chip{font-size:11px; padding:3px 8px; background:#173054; border:1px solid #28406d; border-radius:999px; color:#cbd5e1}

    /* Day Planner (24h) */
    .planner{
      border:1px solid #263754; border-radius:12px; overflow:hidden; background:#0e1729;
      display:flex; flex-direction:column; height:520px;
    }
    .planner-head{
      display:flex; align-items:center; justify-content:space-between; gap:8px;
      padding:8px; border-bottom:1px solid #1f2a44; position:sticky; top:0; background:#0e1729; z-index:2;
    }
    .planner-day{font-weight:700}
    .planner-grid{
      position:relative; flex:1; overflow:auto; -webkit-overflow-scrolling: touch; scroll-behavior:smooth;
      background:
        linear-gradient(#1f2a44 1px, transparent 1px) 0 0/100% 56px; /* hour lines */
    }
    .hour{position:relative; height:56px; padding-left:58px; display:flex; align-items:flex-start; color:#8ea3c2; font-size:12px}
    .hour::before{
      content:attr(data-h); position:absolute; left:8px; top:6px; width:42px; text-align:right; opacity:.8;
    }
    .nowline{
      position:absolute; left:0; right:0; height:2px; background:var(--danger); z-index:1;
      box-shadow:0 0 6px rgba(239,68,68,.7);
    }
    .event{
      position:absolute; left:58px; right:8px; border:1px solid #2c4a7a; background:rgba(59,130,246,.2);
      border-left:3px solid var(--brand); border-radius:10px; padding:6px 8px; color:#e5edf9; font-size:13px;
      display:flex; justify-content:space-between; gap:8px;
    }
    .ev-time{font-size:11px; color:#c7d2fe}
    .ev-chip{font-size:10px; padding:2px 6px; background:#0f2549; border:1px solid #2b4b80; border-radius:999px}

    /* Popup / sheets */
    .sheet{
      position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:flex-end; justify-content:center; z-index:20;
    }
    .sheet.open{display:flex}
    .sheet-card{
      width:100%; max-width:560px; background:#0e1729; border-top-left-radius:16px; border-top-right-radius:16px;
      border:1px solid #1f2a44; padding:14px 14px max(14px, env(safe-area-inset-bottom));
      animation:rise .2s ease-out;
    }
    .sheet h3{margin:0 0 8px}
    .form-row{display:flex; gap:8px; margin:8px 0}
    .select,.time{height:44px}
    .select,.time,.input{appearance:none}

    /* Floating action */
    .fab{
      position:fixed; right:16px; bottom: calc(70px + env(safe-area-inset-bottom));
      width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--brand-2));
      display:flex; align-items:center; justify-content:center; border:none; color:#fff; font-size:22px; z-index:8; box-shadow:0 8px 28px rgba(59,130,246,.45);
    }

    /* Stats pills */
    .stats{display:grid; grid-template-columns: repeat(3,1fr); gap:8px}
    .pill{background:#0e1729; border:1px solid #263754; border-radius:12px; text-align:center; padding:10px}
    .num{font-size:1.2rem; color:var(--brand); font-weight:800}

    /* Animations */
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.0)} 50%{box-shadow:0 0 0 8px rgba(16,185,129,.12)}}
    @keyframes rise{from{transform:translateY(12px);opacity:0} to{transform:none;opacity:1}}
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div id="focusIndicator" class="dot" aria-hidden="true"></div>
        <div>
          <div style="font-weight:800">Focus Intervention</div>
          <div id="statusText" style="font-size:12px;color:#93a5c4">Monitoring focus‚Ä¶</div>
        </div>
        <div class="hdr-right">
          <span id="timerDisplay">00:00</span>
          <span id="offlineIndicator" class="chip" style="display:none;background:#3c1420;border-color:#702a3a;color:#fecaca">Offline</span>
        </div>
      </div>
    </header>

    <main class="content">
      <!-- Mobile Tabs: show one section at a time -->
      <div class="tabs" id="tabs" hidden></div>

      <div id="view-matrix" class="section">
        <h2>Eisenhower Matrix</h2>
        <div class="matrix">
          <button class="quad q1" onclick="selectQuadrant(1)"><h3>üî• DO NOW</h3><p>Urgent + Important</p></button>
          <button class="quad q2" onclick="selectQuadrant(2)"><h3>üìÖ SCHEDULE</h3><p>Important + Not Urgent</p></button>
          <button class="quad q3" onclick="selectQuadrant(3)"><h3>üë• DELEGATE</h3><p>Urgent + Not Important</p></button>
          <button class="quad q4" onclick="selectQuadrant(4)"><h3>üóëÔ∏è ELIMINATE</h3><p>Not Urgent + Not Important</p></button>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn ok" onclick="startFocusSession()">üéØ Start Focus</button>
          <button class="btn warn" onclick="setFocusReminder()">‚è∞ Reminders</button>
          <button class="btn" onclick="quickIntervention()">üö® I'm Scrolling!</button>
          <button class="btn danger" onclick="emergencyRefocus()">üí• Emergency</button>
        </div>

        <div class="stats" style="margin-top:12px">
          <div class="pill"><div class="num" id="focusTime">0</div><div class="muted">Minutes Focused</div></div>
          <div class="pill"><div class="num" id="interventions">0</div><div class="muted">Interventions</div></div>
          <div class="pill"><div class="num" id="tasksCompleted">0</div><div class="muted">Tasks Done</div></div>
        </div>
      </div>

      <div id="view-tasks" class="section">
        <h2>Tasks</h2>
        <div class="task-add">
          <input id="taskInput" class="input" placeholder="Add task‚Ä¶ e.g. Draft report due:2025-09-30 #work P2" />
          <button class="btn ok" onclick="addTask()">Add</button>
        </div>
        <div id="taskList" class="tasklist" role="list"></div>
      </div>

      <div id="view-calendar" class="section">
        <h2 style="margin-bottom:6px">Day Planner</h2>
        <div class="planner" id="planner">
          <div class="planner-head">
            <button class="btn ghost" onclick="shiftDay(-1)">‚óÄ</button>
            <div class="planner-day" id="plannerDayLabel">Today</div>
            <div class="row">
              <button class="btn ghost" onclick="goToday()">Today</button>
              <button class="btn ghost" onclick="shiftDay(1)">‚ñ∂</button>
            </div>
          </div>
          <div class="planner-grid" id="plannerGrid" onclick="tapHour(event)">
            <!-- Hours injected -->
          </div>
        </div>
      </div>

      <div id="view-stats" class="section">
        <h2>Activity</h2>
        <div class="stats" style="margin-top:12px">
          <div class="pill"><div class="num" id="statTotalTasks">0</div><div class="muted">Total Tasks</div></div>
          <div class="pill"><div class="num" id="statTodayEvents">0</div><div class="muted">Today‚Äôs Events</div></div>
          <div class="pill"><div class="num" id="statFocusStreak">0</div><div class="muted">Focus Streak (days)</div></div>
        </div>
      </div>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="tabbar" role="tablist" aria-label="Primary">
      <button class="tabbtn active" data-view="matrix" onclick="switchView('matrix')">üèπ<span>Matrix</span></button>
      <button class="tabbtn" data-view="tasks" onclick="switchView('tasks')">‚úÖ<span>Tasks</span></button>
      <button class="tabbtn" data-view="calendar" onclick="switchView('calendar')">üìÖ<span>Calendar</span></button>
      <button class="tabbtn" data-view="stats" onclick="switchView('stats')">üìà<span>Stats</span></button>
    </nav>

    <!-- Floating Add -->
    <button class="fab" title="Quick add" onclick="openQuickAdd()">Ôºã</button>
  </div>

  <!-- Quick Add Sheet -->
  <div class="sheet" id="quickSheet" aria-hidden="true">
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="qa-title">
      <h3 id="qa-title">Quick Add</h3>
      <input id="qa-title-input" class="input" placeholder="Title" />
      <div class="form-row">
        <input id="qa-start" type="time" class="input time" />
        <input id="qa-dur" type="number" class="input" min="15" step="15" value="30" placeholder="Duration (min)" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeQuickAdd()">Cancel</button>
        <button class="btn ok" onclick="saveQuickAdd()">Save</button>
      </div>
    </div>
  </div>

  <!-- Intervention Popup (kept minimal, touch-friendly) -->
  <div class="sheet" id="interventionPopup" aria-hidden="true">
    <div class="sheet-card" role="dialog" aria-modal="true">
      <h3>‚ö†Ô∏è FOCUS BREAK!</h3>
      <p id="interventionMessage" style="color:#cbd5e1;margin:8px 0 12px">Time to stop scrolling and get back to what matters!</p>
      <input type="text" class="input" id="currentTask" placeholder="What should you be working on right now?" />
      <div class="row" style="margin-top:10px">
        <button class="btn ok" onclick="commitToTask()">‚úÖ Do This Now</button>
        <button class="btn warn" onclick="setBreakTimer()">‚è≥ 5-min Break</button>
        <button class="btn danger" onclick="closeIntervention()">‚ùå Ignore</button>
      </div>
    </div>
  </div>

  <script>
  // ---------------- State ----------------
  const state = {
    isActive:false, startTime:null,
    totalFocusTime: +localStorage.getItem('totalFocusTime')||0,
    interventions: +localStorage.getItem('interventions')||0,
    tasksCompleted: +localStorage.getItem('tasksCompleted')||0,
    notificationsEnabled: false,
    tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
    events: JSON.parse(localStorage.getItem('events')||'[]'), // {id,title,start,end,day}
    view: 'matrix',
    currentDay: new Date()
  };

  // ---------------- PWA SW ----------------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').then(reg=>{
        // Listen for updates to show in-app banner (optional)
        reg.addEventListener('updatefound', ()=>{
          const nw = reg.installing;
          nw?.addEventListener('statechange', ()=>{
            if (nw.state==='installed' && navigator.serviceWorker.controller){
              showToast('üîÑ App Update Available ‚Äî pull to refresh or reopen to update.');
            }
          });
        });
      });
      navigator.serviceWorker.addEventListener('message', (e)=>{
        if (e.data?.type==='SYNC_SUCCESS') showToast('Data synced');
      });
    });
  }

  // ---------------- Helpers ----------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function showToast(msg){ try{ if(state.notificationsEnabled) new Notification('Focus', {body:msg,icon:'./icons/icon-192.png'}); }catch{} }
  function save(){ localStorage.setItem('tasks', JSON.stringify(state.tasks)); localStorage.setItem('events', JSON.stringify(state.events)); localStorage.setItem('totalFocusTime', state.totalFocusTime); localStorage.setItem('interventions', state.interventions); localStorage.setItem('tasksCompleted', state.tasksCompleted); }

  // ---------------- Tabs (mobile) ----------------
  function switchView(name){
    state.view = name;
    ['matrix','tasks','calendar','stats'].forEach(v=>{
      $('#view-'+v).style.display = (v===name || window.innerWidth>=900)?'block':'none';
      const btn = document.querySelector(`.tabbtn[data-view="${v}"]`); if(btn) btn.classList.toggle('active', v===name);
    });
    if(name==='calendar') requestAnimationFrame(()=>scrollToNow());
  }
  window.addEventListener('resize', ()=> switchView(state.view));
  switchView('matrix');

  // ---------------- Notifications ----------------
  function requestNotifications(){
    if(!('Notification' in window)) return;
    Notification.requestPermission().then(p=>{
      if(p==='granted'){ state.notificationsEnabled=true; showToast('Focus reminders enabled'); }
    });
  }
  // auto-enable toggle UI if already granted
  if('Notification' in window && Notification.permission==='granted') state.notificationsEnabled=true;

  // ---------------- Focus Timer ----------------
  function startFocusSession(){
    state.isActive = true; state.startTime = Date.now();
    $('#focusIndicator').classList.add('active'); $('#statusText').textContent = 'Focus session active';
    tick();
    if(state.notificationsEnabled) new Notification('Focus Session Started!', { body:'Time to get things done üéØ', icon:'./icons/icon-192.png'});
  }
  function tick(){
    if(!state.isActive) return;
    const s = Math.floor((Date.now()-state.startTime)/1000);
    const m = Math.floor(s/60), ss = String(s%60).padStart(2,'0');
    $('#timerDisplay').textContent = `${String(m).padStart(2,'0')}:${ss}`;
    if(s>0 && s%60===0){ state.totalFocusTime++; updateStats(); save(); }
    requestAnimationFrame(tick);
  }
  function setFocusReminder(){
    const mins = parseInt(prompt('Remind every how many minutes?','15')); if(!mins) return;
    setInterval(()=> showIntervention(`Focus check! It‚Äôs been ${mins} minutes.`), mins*60*1000);
    showToast(`Reminders every ${mins} min`);
    requestNotifications();
  }
  function quickIntervention(){
    const msgs=['What should you be working on right now?','Are you being productive or just busy?','Stop scrolling. Start doing.','Focus time! What‚Äôs the ONE thing?'];
    showIntervention(msgs[Math.floor(Math.random()*msgs.length)]);
    state.interventions++; updateStats(); save();
  }
  function emergencyRefocus(){
    showIntervention('üö® EMERGENCY REFOCUS! Drop everything and focus on what matters most right NOW!');
    state.interventions++; updateStats(); save();
  }
  function showIntervention(text){
    $('#interventionMessage').textContent = text;
    openSheet('#interventionPopup');
    $('#currentTask').focus();
  }
  function closeIntervention(){ closeSheet('#interventionPopup'); $('#currentTask').value=''; }
  function commitToTask(){
    const t = $('#currentTask').value.trim(); if(!t){ alert('Enter what you will work on'); return; }
    state.tasksCompleted++; startFocusSession(); closeIntervention(); showToast(`Working on: ${t}`); updateStats(); save();
  }
  function setBreakTimer(){
    closeIntervention(); showToast('5-minute break started');
    setTimeout(()=> showIntervention('Break‚Äôs over! Time to get back to it!'), 5*60*1000);
  }

  // ---------------- Tasks ----------------
  function addTask(){
    const v = $('#taskInput').value.trim(); if(!v) return;
    state.tasks.push({ id:crypto.randomUUID(), title:v, done:false, created:Date.now() });
    $('#taskInput').value=''; renderTasks(); save();
  }
  function toggleTask(id){
    const t = state.tasks.find(x=>x.id===id); if(!t) return; t.done=!t.done; if(t.done) state.tasksCompleted++; renderTasks(); updateStats(); save();
  }
  function toCalendar(id){
    const t = state.tasks.find(x=>x.id===id); if(!t) return;
    openQuickAdd(t.title);
  }
  function deleteTask(id){
    state.tasks = state.tasks.filter(x=>x.id!==id); renderTasks(); save();
  }
  function renderTasks(){
    const root = $('#taskList'); root.innerHTML='';
    if(state.tasks.length===0){ root.innerHTML='<div class="muted" style="padding:8px">No tasks yet.</div>'; return;}
    state.tasks.forEach(t=>{
      const el = document.createElement('div'); el.className='task';
      el.innerHTML = `
        <input type="checkbox" ${t.done?'checked':''} style="width:20px;height:20px" aria-label="Complete" />
        <div class="title" style="${t.done?'text-decoration:line-through;color:#9aa9c4':''}">${t.title}</div>
        <span class="chip">Task</span>
        <button class="btn ghost" title="Schedule" aria-label="Add to calendar">üìÖ</button>
        <button class="btn ghost" title="Delete" aria-label="Delete">üóë</button>
      `;
      const [cb,, , btnCal, btnDel] = el.querySelectorAll('input, .title, .chip, button, button');
      cb.addEventListener('change',()=>toggleTask(t.id));
      btnCal.addEventListener('click',()=>toCalendar(t.id));
      btnDel.addEventListener('click',()=>deleteTask(t.id));
      root.appendChild(el);
    });
    $('#statTotalTasks').textContent = state.tasks.length;
  }

  // ---------------- Day Planner ----------------
  const grid = $('#plannerGrid');
  function setDayLabel(){
    const d = state.currentDay;
    const today = new Date(); today.setHours(0,0,0,0);
    const cmp = new Date(d); cmp.setHours(0,0,0,0);
    const same = cmp.getTime()===today.getTime();
    const options={weekday:'short', month:'short', day:'numeric'};
    $('#plannerDayLabel').textContent = (same?'Today ‚Äî ':'') + d.toLocaleDateString([], options);
  }
  function hoursMarkup(){
    let html=''; for(let h=0;h<24;h++){ const lab = (h%12||12)+(h<12?'a':'p'); html+=`<div class="hour" data-hour="${h}" data-h="${lab}"></div>`; }
    grid.innerHTML = html + `<div class="nowline" id="nowLine" style="display:none"></div>`;
  }
  function renderEvents(){
    // clear existing
    grid.querySelectorAll('.event').forEach(e=>e.remove());
    const dayKey = dayId(state.currentDay);
    const events = state.events.filter(ev=>ev.day===dayKey);
    events.forEach(ev=> placeEvent(ev));
    // show now line if same day
    const now = new Date(); const show = dayId(now)===dayKey;
    const nl = $('#nowLine'); nl.style.display = show?'block':'none';
    if(show){
      const mins = now.getHours()*60 + now.getMinutes();
      nl.style.top = (mins*56/60) + 'px';
    }
    $('#statTodayEvents').textContent = events.length;
  }
  function placeEvent(ev){
    const startM = ev.start; const endM = ev.end;
    const top = startM * 56 / 60;
    const height = Math.max(30, (endM - startM) * 56 / 60);
    const el = document.createElement('div'); el.className='event';
    el.style.top = `${top}px`; el.style.height = `${height}px`;
    el.innerHTML = `
      <div>
        <div>${ev.title}</div>
        <div class="ev-time">${minToLabel(startM)}‚Äì${minToLabel(endM)}</div>
      </div>
      <div class="ev-chip">Focus</div>
    `;
    grid.appendChild(el);
  }
  function minToLabel(m){ const h = Math.floor(m/60), mm = m%60; const ap = h<12?'a':'p'; const hh = h%12||12; return `${hh}:${String(mm).padStart(2,'0')}${ap}`; }
  function labelToMin(val){ const [H,M] = val.split(':').map(n=>+n); return H*60 + M; }

  function dayId(d){ const dt = new Date(d); dt.setHours(0,0,0,0); return dt.toISOString().slice(0,10); }
  function shiftDay(n){ state.currentDay.setDate(state.currentDay.getDate()+n); setDayLabel(); renderEvents(); }
  function goToday(){ state.currentDay = new Date(); setDayLabel(); renderEvents(); scrollToNow(); }
  function scrollToNow(){ const dayKey = dayId(new Date()); if(dayId(state.currentDay)!==dayKey) return; const y = (new Date().getHours()*60 + new Date().getMinutes())*56/60 - 140; grid.scrollTo({top: Math.max(0,y), behavior:'smooth'}); }

  function tapHour(e){
    // Tap anywhere ‚Üí open Quick Add with rounded start time
    const rect = grid.getBoundingClientRect();
    const y = e.clientY - rect.top + grid.scrollTop;
    const mins = Math.max(0, Math.min(23*60+59, Math.round((y/56)*60/15)*15)); // snap 15m
    openQuickAdd('', mins);
  }

  // Quick Add
  function openQuickAdd(prefillTitle='', startMin=null){
    $('#qa-title-input').value = prefillTitle || '';
    // set default time to rounded next 15m or the tapped minute
    const base = startMin!=null ? startMin : Math.round(((new Date().getHours()*60 + new Date().getMinutes())+7.5)/15)*15;
    const hh = String(Math.floor(base/60)).padStart(2,'0'); const mm = String(base%60).padStart(2,'0');
    $('#qa-start').value = `${hh}:${mm}`;
    openSheet('#quickSheet');
  }
  function saveQuickAdd(){
    const title = $('#qa-title-input').value.trim(); if(!title){ alert('Enter a title'); return; }
    const t = $('#qa-start').value || '09:00';
    const dur = Math.max(15, +($('#qa-dur').value||30));
    const start = labelToMin(t); const end = Math.min(24*60, start+dur);
    const ev = { id:crypto.randomUUID(), title, start, end, day: dayId(state.currentDay) };
    state.events.push(ev); save(); closeQuickAdd(); renderEvents();
  }
  function closeQuickAdd(){ closeSheet('#quickSheet'); }

  // Sheets
  function openSheet(sel){ const s=$(sel); s.classList.add('open'); s.setAttribute('aria-hidden','false'); }
  function closeSheet(sel){ const s=$(sel); s.classList.remove('open'); s.setAttribute('aria-hidden','true'); }

  // ---------------- Matrix actions ----------------
  function selectQuadrant(q){
    const names=['','DO NOW','SCHEDULE','DELEGATE','ELIMINATE'];
    const tips=['',
      'Urgent & important ‚Äî do it immediately.',
      'Important, not urgent ‚Äî schedule time.',
      'Urgent, not important ‚Äî delegate it.',
      'Not urgent/important ‚Äî remove or limit.'
    ];
    showIntervention(`${names[q]}: ${tips[q]}`);
  }

  // ---------------- Stats ----------------
  function updateStats(){
    $('#focusTime').textContent = state.totalFocusTime;
    $('#interventions').textContent = state.interventions;
    $('#tasksCompleted').textContent = state.tasksCompleted;
  }

  // ---------------- Network status ----------------
  window.addEventListener('online', ()=>{ $('#offlineIndicator').style.display='none'; showToast('Back Online!'); try{ navigator.serviceWorker.ready.then(r=>r.sync.register('focus-data-sync')); }catch{} });
  window.addEventListener('offline', ()=>{ $('#offlineIndicator').style.display='inline-block'; });

  // ---------------- Boot ----------------
  function boot(){
    // Hours grid
    hoursMarkup();
    setDayLabel();
    renderTasks();
    renderEvents();
    updateStats();
    // Scroll to now after render
    setTimeout(scrollToNow, 250);

    // PWA shortcut actions
    const action = new URLSearchParams(location.search).get('action');
    if(action==='focus') setTimeout(quickIntervention, 600);
    else if(action==='start') setTimeout(startFocusSession, 600);
    else if(action==='emergency') setTimeout(emergencyRefocus, 400);

    // Gentle nudge every 15m if notifications enabled
    setInterval(()=>{ if(state.notificationsEnabled) showToast('Focus check ‚Äî what are you working on?'); }, 15*60*1000);

    // Simple page scroll (still helpful if no extension)
    let sc=0, t=null; addEventListener('scroll',()=>{ sc++; clearTimeout(t); t=setTimeout(()=>{ if(sc>12) setTimeout(()=>showIntervention('Rapid scrolling detected!'), 600); sc=0; }, 800); }, {passive:true});

    // Ask for notifications the first time
    if('Notification' in window && Notification.permission!=='granted'){
      setTimeout(()=>requestNotifications(), 1200);
    }
  }
  document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
