<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Focus Intervention</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0f172a" />
  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192.png" />
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png" />

  <style>
    :root{
      --bg:#0f172a; --bg-2:#111827; --card:#162238; --muted:#94a3b8; --brand:#3b82f6; --brand-2:#1d4ed8;
      --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring:#334155;
      --radius:14px; --space:16px; --tap:44px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
      background:linear-gradient(135deg, #0f172a, #1e293b); color:#fff;
      -webkit-tap-highlight-color: transparent;
    }

    /* Layout */
    .app{min-height:100%; display:flex; flex-direction:column; padding-bottom: calc(56px + env(safe-area-inset-bottom));}
    header{
      position:sticky; top:0; z-index:5;
      background:rgba(15,23,42,.85); backdrop-filter: blur(8px);
      padding: max(12px, env(safe-area-inset-top)) var(--space) 10px;
      border-bottom:1px solid #1f2a44;
    }
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px; height:10px; border-radius:50%; background:var(--danger); box-shadow:0 0 0 0 rgba(16,185,129,.4); transition:.3s}
    .dot.active{background:var(--ok); animation:pulse 2s infinite}
    .hdr-right{margin-left:auto; display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}

    .content{flex:1; padding:12px var(--space); max-width:1000px; width:100%; margin:0 auto}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){
      .grid{grid-template-columns: 1.1fr .9fr}
      .section{min-height:520px}
    }

    .section{
      background:rgba(15,23,42,.6); border:1px solid var(--ring);
      border-radius:var(--radius); padding:12px;
    }
    .section h2{margin:0 0 10px; font-size:1.05rem}

    /* Tabs (mobile) */
    .tabbar{
      position:fixed; bottom:0; left:0; right:0; z-index:9;
      background:rgba(15,23,42,.96); backdrop-filter: blur(8px);
      border-top:1px solid #1f2a44; height:56px; padding:6px max(10px, env(safe-area-inset-left)) max(6px, env(safe-area-inset-bottom)) max(10px, env(safe-area-inset-right));
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px;
    }
    .tabbtn{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      min-height:44px; border-radius:12px; color:#cbd5e1; border:1px solid transparent; font-size:11px;
    }
    .tabbtn.active{color:#fff; border-color:#28406d; background:#12203a}
    @media(min-width:900px){ .tabbar{display:none} }

    /* Buttons & inputs */
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; min-height:var(--tap); border-radius:10px; border:1px solid #2a3a57; background:linear-gradient(135deg,#28406d,#1b2e52); color:#fff; cursor:pointer; font-weight:600}
    .btn:active{transform: translateY(1px)}
    .btn.ok{background:linear-gradient(135deg,#16a34a,#0f7a3a); border-color:#0f7a3a}
    .btn.warn{background:linear-gradient(135deg,#f59e0b,#b45309); border-color:#b45309}
    .btn.danger{background:linear-gradient(135deg,#ef4444,#b91c1c); border-color:#b91c1c}
    .btn.ghost{background:transparent}
    .row{display:flex; gap:8px; flex-wrap:wrap}
    .chip{font-size:11px; padding:3px 8px; background:#173054; border:1px solid #28406d; border-radius:999px; color:#cbd5e1}

    /* Matrix */
    .matrix{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media(max-width:899px){ .matrix{grid-template-columns:1fr} }
    .quad{padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,.15); cursor:pointer}
    .q1{background:linear-gradient(135deg,#b91c1c,#ef4444)}
    .q2{background:linear-gradient(135deg,#059669,#10b981)}
    .q3{background:linear-gradient(135deg,#d97706,#f59e0b)}
    .q4{background:linear-gradient(135deg,#6366f1,#4338ca)}
    .quad h3{margin:0 0 6px; font-size:1rem}
    .quad p{margin:0; opacity:.9; font-size:.9rem}

    /* Tasks */
    .task-add{display:flex; gap:8px; margin:10px 0}
    .input{flex:1; padding:12px; min-height:var(--tap); border-radius:10px; border:1px solid #2a3a57; background:#111c30; color:#fff; font-size:16px;}
    .tasklist{display:grid; gap:8px; max-height:360px; overflow:auto; padding-right:2px}
    .task{display:flex; align-items:center; gap:8px; padding:10px; border:1px solid #263754; background:#0f1a30; border-radius:10px}
    .task .title{flex:1}

    /* Planner (24h) */
    .planner{border:1px solid #263754; border-radius:12px; overflow:hidden; background:#0e1729; display:flex; flex-direction:column; height:520px;}
    .planner-head{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px; border-bottom:1px solid #1f2a44; position:sticky; top:0; background:#0e1729; z-index:3;}
    .planner-day{font-weight:700}
    .weekstrip{display:flex; gap:6px; overflow:auto; -webkit-overflow-scrolling:touch; padding:6px 8px; border-bottom:1px solid #1f2a44; background:#0e1729; position:sticky; top:44px; z-index:2;}
    .daybtn{min-width:48px; padding:8px 10px; border-radius:10px; border:1px solid #263754; background:#0f1a30; color:#cbd5e1; display:flex; flex-direction:column; align-items:center; gap:2px; font-size:12px; cursor:pointer;}
    .daybtn strong{font-size:13px; color:#e5edf9}
    .daybtn.active{border-color:#2b4b80; background:#112241}

    .planner-grid{position:relative; flex:1; overflow:auto; -webkit-overflow-scrolling: touch; scroll-behavior:smooth; background: linear-gradient(#1f2a44 1px, transparent 1px) 0 0/100% 56px;}
    .hour{position:relative; height:56px; padding-left:58px; display:flex; align-items:flex-start; color:#8ea3c2; font-size:12px}
    .hour::before{content:attr(data-h); position:absolute; left:8px; top:6px; width:42px; text-align:right; opacity:.8;}
    .nowline{position:absolute; left:0; right:0; height:2px; background:var(--danger); z-index:1; box-shadow:0 0 6px rgba(239,68,68,.7);}
    .event{position:absolute; left:58px; right:8px; border:1px solid #2c4a7a; background:rgba(59,130,246,.2); border-left:3px solid var(--brand); border-radius:10px; padding:6px 8px; color:#e5edf9; font-size:13px; display:flex; justify-content:space-between; gap:8px;}
    .ev-time{font-size:11px; color:#c7d2fe}
    .ev-chip{font-size:10px; padding:2px 6px; background:#0f2549; border:1px solid #2b4b80; border-radius:999px}

    /* Sheets */
    .sheet{position:fixed; inset:0; background:rgba(0,0,0,.65); display:none; align-items:flex-end; justify-content:center; z-index:20;}
    .sheet.open{display:flex}
    .sheet-card{width:100%; max-width:560px; background:#0e1729; border-top-left-radius:16px; border-top-right-radius:16px; border:1px solid #1f2a44; padding:14px 14px max(14px, env(safe-area-inset-bottom)); animation:rise .2s ease-out;}
    .sheet h3{margin:0 0 8px}
    .form-row{display:flex; gap:8px; margin:8px 0}
    .select,.time{height:44px}
    .select,.time,.input{appearance:none}
    .switch{display:flex; align-items:center; gap:8px}
    .range{width:100%}
    .small{font-size:12px; color:#93a5c4}

    /* Floating action */
    .fab{position:fixed; right:16px; bottom: calc(70px + env(safe-area-inset-bottom)); width:56px; height:56px; border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:flex; align-items:center; justify-content:center; border:none; color:#fff; font-size:22px; z-index:8; box-shadow:0 8px 28px rgba(59,130,246,.45);}

    /* Stats */
    .stats{display:grid; grid-template-columns: repeat(3,1fr); gap:8px}
    .pill{background:#0e1729; border:1px solid #263754; border-radius:12px; text-align:center; padding:10px}
    .num{font-size:1.2rem; color:var(--brand); font-weight:800}

    /* Added: Productivity card + Weekly list visuals (match your theme) */
    .card-grad{background:linear-gradient(135deg, rgba(59,130,246,.18), rgba(99,102,241,.16)); border:1px solid #2b4b80; border-radius:12px; padding:12px}
    .bar{height:8px; border-radius:999px; background:#0f1a30; border:1px solid #263754; overflow:hidden}
    .bar > i{display:block; height:100%; width:0; background:linear-gradient(90deg, #3b82f6, #22d3ee);}

    /* Animations */
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.0)} 50%{box-shadow:0 0 0 8px rgba(16,185,129,.12)}}
    @keyframes rise{from{transform:translateY(12px);opacity:0} to{transform:none;opacity:1}}

    /* ===== CLEAN MODE (White, simplified) ===== */
.clean body{
  background:linear-gradient(135deg,#f8fafc,#e2e8f0);
  color:#0f172a;
}
.clean header{
  background:rgba(241,245,249,.94);
  border-bottom:1px solid #cbd5e1;
}
.clean .section{
  background:#ffffff;
  border:1px solid #e2e8f0;
}
.clean .btn{
  background:linear-gradient(135deg,#e2e8f0,#cbd5e1);
  border:1px solid #cbd5e1;
  color:#0f172a;
}
.clean .btn.ok{ background:linear-gradient(135deg,#34d399,#059669); color:#fff; border-color:#059669; }
.clean .btn.warn{ background:linear-gradient(135deg,#fbbf24,#d97706); color:#fff; border-color:#d97706; }
.clean .btn.danger{ background:linear-gradient(135deg,#f87171,#b91c1c); color:#fff; border-color:#b91c1c; }
.clean .btn.ghost{ background:transparent; border-color:transparent; }

/* chips, pills */
.clean .chip{ background:#eef2f7; border-color:#d7dee8; color:#334155; }
.clean .pill{ background:#f8fafc; border-color:#e2e8f0; }
.clean .num{ color:#2563eb; }

/* planner + events */
.clean .planner{ background:#f8fafc; border:1px solid #e2e8f0; }
.clean .planner-head, .clean .weekstrip{ background:#f8fafc; border-color:#cbd5e1; }
.clean .hour{ color:#475569; }
.clean .event{ background:rgba(59,130,246,.15); border:1px solid #93c5fd; color:#1e3a8a; }
.clean .ev-time{ color:#1e40af; }

/* list and cards */
.clean .task{ background:#f8fafc; border:1px solid #e2e8f0; }
.clean .content{ max-width:860px; }

/* focus dot contrast */
.clean .dot{ box-shadow:none; }
.clean .dot.active{ box-shadow:0 0 0 0 rgba(16,185,129,0.0); }

/* Simplify: hide Calendar & Activity in Clean Mode */
.clean #view-calendar,
.clean #view-stats{ display:none !important; }
.clean .tabbtn[data-view="calendar"],
.clean .tabbtn[data-view="stats"]{ opacity:.35; pointer-events:none; }
  </style>
</head>

<body>
  <div class="app">
    <header>
      <div class="brand">
        <div id="focusIndicator" class="dot" aria-hidden="true"></div>
        <div>
          <div style="font-weight:800">Focus Intervention</div>
          <div id="statusText" style="font-size:12px;color:#93a5c4">Monitoring focus‚Ä¶</div>
        </div>
        <div class="hdr-right">
          <span id="timerDisplay">00:00</span>
          <span id="offlineIndicator" class="chip" style="display:none;background:#3c1420;border-color:#702a3a;color:#fecaca">Offline</span>
          <button class="btn ghost" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
      </div>
    </header>

    <main class="content">
      <div id="view-matrix" class="section">
        <h2>Eisenhower Matrix</h2>
        <div class="matrix">
          <button class="quad q1" onclick="selectQuadrant(1)"><h3>üî• DO NOW</h3><p>Urgent + Important</p></button>
          <button class="quad q2" onclick="selectQuadrant(2)"><h3>üìÖ SCHEDULE</h3><p>Important + Not Urgent</p></button>
          <button class="quad q3" onclick="selectQuadrant(3)"><h3>üë• DELEGATE</h3><p>Urgent + Not Important</p></button>
          <button class="quad q4" onclick="selectQuadrant(4)"><h3>üóëÔ∏è ELIMINATE</h3><p>Not Urgent + Not Important</p></button>
        </div>

        <div class="row" style="margin-top:10px">
          <!-- Start button now toggles to Stop during a session (no UI redesign) -->
          <button id="focusToggleBtn" class="btn ok" onclick="toggleFocusSession()">üéØ Start Focus</button>
          <button class="btn warn" onclick="setFocusReminder()">‚è∞ Reminders</button>
          <button class="btn" onclick="quickIntervention()">üö® I'm Scrolling!</button>
          <button class="btn danger" onclick="emergencyRefocus()">üí• Emergency</button>
        </div>

        <div class="stats" style="margin-top:12px">
          <div class="pill"><div class="num" id="focusTime">0</div><div class="muted">Minutes Focused</div></div>
          <div class="pill"><div class="num" id="interventions">0</div><div class="muted">Interventions</div></div>
          <div class="pill"><div class="num" id="tasksCompleted">0</div><div class="muted">Tasks Done</div></div>
        </div>
      </div>

      <div id="view-tasks" class="section">
        <h2>Tasks</h2>
        <div class="task-add">
          <input id="taskInput" class="input" placeholder="Add task‚Ä¶ e.g. Draft report due:2025-09-30 #work P2" />
          <button class="btn ok" onclick="addTask()">Add</button>
        </div>
        <div id="taskList" class="tasklist" role="list"></div>

        <!-- Added: Completed This Week -->
        <div class="card-grad" style="margin-top:12px">
          <h3 style="margin:0 0 6px">‚úî Completed This Week</h3>
          <ul id="weeklyCompletedList" class="small" style="margin:0; padding-left:18px"></ul>
        </div>
      </div>

      <div id="view-calendar" class="section">
        <h2 style="margin-bottom:6px">Day Planner</h2>
        <div class="planner" id="planner">
          <div class="planner-head">
            <button class="btn ghost" onclick="shiftDay(-1)">‚óÄ</button>
            <div class="planner-day" id="plannerDayLabel">Today</div>
            <div class="row">
              <button class="btn ghost" onclick="goToday()">Today</button>
              <button class="btn ghost" onclick="shiftDay(1)">‚ñ∂</button>
            </div>
          </div>

          <!-- Week strip -->
          <div class="weekstrip" id="weekStrip"></div>

          <div class="planner-grid" id="plannerGrid" onclick="tapHour(event)"></div>
        </div>
      </div>

      <div id="view-stats" class="section">
        <h2>Activity</h2>
        <div class="stats" style="margin-top:12px">
          <div class="pill"><div class="num" id="statTotalTasks">0</div><div class="muted">Total Tasks</div></div>
          <div class="pill"><div class="num" id="statTodayEvents">0</div><div class="muted">Today‚Äôs Events</div></div>
          <div class="pill"><div class="num" id="statFocusStreak">0</div><div class="muted">Focus Streak (days)</div></div>
        </div>

        <!-- Added: Productivity Summary (non-invasive, matches theme) -->
        <div class="card-grad" style="margin-top:12px">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 style="margin:0">Productivity Summary</h3>
            <span id="prodTrendBadge" class="chip" style="background:#0f2549;border-color:#2b4b80;color:#a5f3fc">+0%</span>
          </div>
          <div class="stats" style="margin-top:8px">
            <div class="pill"><div class="num" id="prodTasksViaApp">0</div><div class="muted">Tasks (via app)</div></div>
            <div class="pill"><div class="num" id="prodFocusHours">0.0</div><div class="muted">Focus Hours</div></div>
            <div class="pill"><div class="num" id="prodSessions">0</div><div class="muted">Sessions</div></div>
          </div>
          <div class="row" style="align-items:center; gap:8px; margin-top:10px">
            <span class="small" style="color:#cbd5e1">Progress vs last week</span>
            <span id="prodTrend" class="small" style="color:#e5edf9">0%</span>
          </div>
          <div class="bar" style="margin-top:6px"><i id="prodBar"></i></div>
        </div>
      </div>
    </main>

    <!-- Bottom Tab Bar -->
    <nav class="tabbar" role="tablist" aria-label="Primary">
      <button class="tabbtn active" data-view="matrix" onclick="switchView('matrix')">üèπ<span>Matrix</span></button>
      <button class="tabbtn" data-view="tasks" onclick="switchView('tasks')">‚úÖ<span>Tasks</span></button>
      <button class="tabbtn" data-view="calendar" onclick="switchView('calendar')">üìÖ<span>Calendar</span></button>
      <button class="tabbtn" data-view="stats" onclick="switchView('stats')">üìà<span>Stats</span></button>
    </nav>

    <!-- Floating Add -->
    <button class="fab" title="Quick add" onclick="openQuickAdd()">Ôºã</button>
  </div>

  <!-- Quick Add Sheet -->
  <div class="sheet" id="quickSheet" aria-hidden="true">
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="qa-title">
      <h3 id="qa-title">Quick Add</h3>
      <input id="qa-title-input" class="input" placeholder="Title" />
      <div class="form-row">
        <input id="qa-start" type="time" class="input time" />
        <input id="qa-dur" type="number" class="input" min="15" step="15" value="30" placeholder="Duration (min)" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn ghost" onclick="closeQuickAdd()">Cancel</button>
        <button class="btn ok" onclick="saveQuickAdd()">Save</button>
      </div>
    </div>
  </div>

  <!-- Settings Sheet -->
  <div class="sheet" id="settingsSheet" aria-hidden="true">
    <div class="sheet-card" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <h3 id="settings-title">Settings</h3>
      <!-- Clean Mode (white theme) -->
      <!-- Clean Mode (white theme) -->
      <div class="switch" style="margin:8px 0">
        <input id="cleanMode" type="checkbox">
        <label for="cleanMode"><strong>Enable Clean Mode</strong> <span class="small" style="opacity:.8">‚Äî white, simplified</span></label>
      </div>
      <div class="switch" style="margin:8px 0">
        <input id="nudgeEnabled" type="checkbox">
        <label for="nudgeEnabled"><strong>Enable in-app scroll nudge</strong></label>
      </div>
      <div class="small">If you use the browser extension, you can turn this off to avoid double nudges.</div>

      <div style="margin-top:10px">
        <label for="nudgeSensitivity"><strong>Sensitivity</strong> <span id="sensLabel" class="small"></span></label>
        <input id="nudgeSensitivity" class="range" type="range" min="1" max="5" step="1">
        <div class="small">1 = least sensitive, 5 = most sensitive.</div>
      </div>

      <div style="margin-top:10px">
        <label for="nudgeCooldown"><strong>Cooldown (minutes)</strong></label>
        <input id="nudgeCooldown" class="input" type="number" min="0" step="1" value="1">
        <div class="small">Minimum time between two alerts.</div>
      </div>

      <div class="row" style="justify-content:flex-end; margin-top:12px">
        <button class="btn ghost" onclick="closeSettings()">Close</button>
        <button class="btn ok" onclick="saveSettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Intervention Sheet -->
  <div class="sheet" id="interventionPopup" aria-hidden="true">
    <div class="sheet-card" role="dialog" aria-modal="true">
      <h3>‚ö†Ô∏è FOCUS BREAK!</h3>
      <p id="interventionMessage" style="color:#cbd5e1;margin:8px 0 12px">Time to stop scrolling and get back to what matters!</p>
      <input type="text" class="input" id="currentTask" placeholder="What should you be working on right now?" />
      <div class="row" style="margin-top:10px">
        <button class="btn ok" onclick="commitToTask()">‚úÖ Do This Now</button>
        <button class="btn warn" onclick="setBreakTimer()">‚è≥ 5-min Break</button>
        <button class="btn danger" onclick="closeIntervention()">‚ùå Ignore</button>
      </div>
    </div>
  </div>

  <script>
  // ---------------- State ----------------
  const state = {
    isActive:false, startTime:null,  // used by legacy logic; preserved
    totalFocusTime: +localStorage.getItem('totalFocusTime')||0,
    interventions: +localStorage.getItem('interventions')||0,
    tasksCompleted: +localStorage.getItem('tasksCompleted')||0,
    notificationsEnabled: false,
    tasks: JSON.parse(localStorage.getItem('tasks')||'[]'),
    events: JSON.parse(localStorage.getItem('events')||'[]'), // {id,title,start,end,day}
    view: 'matrix',
    currentDay: new Date(),

    // Added: accurate timer persistence & focus sessions
    timer: JSON.parse(localStorage.getItem('fi_timer')||'{"base":0,"runningSince":null,"savedAt":null}'),
    focusSessions: JSON.parse(localStorage.getItem('focusSessions')||'[]') // {start,end,durationMs}
  };

  // ---------------- PWA SW ----------------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').then(reg=>{
        reg.addEventListener('updatefound', ()=>{
          const nw = reg.installing;
          nw?.addEventListener('statechange', ()=>{
            if (nw.state==='installed' && navigator.serviceWorker.controller){
              showToast('üîÑ App Update Available ‚Äî pull to refresh or reopen to update.');
            }
          });
        });
      });
      navigator.serviceWorker.addEventListener('message', (e)=>{
        if (e.data?.type==='SYNC_SUCCESS') showToast('Data synced');
      });
    });
  }

  // ---------------- Helpers ----------------
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  function showToast(msg){ try{ if(state.notificationsEnabled) new Notification('Focus', {body:msg,icon:'./icons/icon-192.png'}); }catch{} }
  function save(){
    localStorage.setItem('tasks', JSON.stringify(state.tasks));
    localStorage.setItem('events', JSON.stringify(state.events));
    localStorage.setItem('totalFocusTime', state.totalFocusTime);
    localStorage.setItem('interventions', state.interventions);
    localStorage.setItem('tasksCompleted', state.tasksCompleted);
    localStorage.setItem('focusSessions', JSON.stringify(state.focusSessions));
  }
  function saveTimer(){ localStorage.setItem('fi_timer', JSON.stringify(state.timer)); }

  // ---------------- Tabs (mobile) ----------------
  function switchView(name){
    state.view = name;
    ['matrix','tasks','calendar','stats'].forEach(v=>{
      $('#view-'+v).style.display = (v===name || window.innerWidth>=900)?'block':'none';
      const btn = document.querySelector(`.tabbtn[data-view="${v}"]`); if(btn) btn.classList.toggle('active', v===name);
    });
    if(name==='calendar') requestAnimationFrame(()=>scrollToNow());
  }
  window.addEventListener('resize', ()=> switchView(state.view));
  switchView('matrix');

  // ---------------- Notifications ----------------
  function requestNotifications(){
    if(!('Notification' in window)) return;
    Notification.requestPermission().then(p=>{
      if(p==='granted'){ state.notificationsEnabled=true; showToast('Focus reminders enabled'); }
    });
  }
  if('Notification' in window && Notification.permission==='granted') state.notificationsEnabled=true;

  // ---------------- Accurate Focus Timer (toggle Start/Stop, persists) ----------------
  const TIMER_INTERVAL = 250; // render cadence; time is computed from wall clock
  let _rafId = null, _uiInterval = null, _runStartISO = null;
  function timerElapsedMs(){
    const { base, runningSince, savedAt } = state.timer;
    if (runningSince==null) return base||0;
    // compensate for time away using savedAt
    const now = Date.now();
    const drift = (savedAt? now - savedAt : 0);
    return base + (now - runningSince) + (drift>0?0:0);
  }
  function renderTimer(){
    const ms = timerElapsedMs();
    const totalSec = Math.floor(ms/1000);
    const m = Math.floor(totalSec/60);
    const s = totalSec%60;
    $('#timerDisplay').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  }
  function startTimer(){
    if (state.timer.runningSince!=null) return;
    state.timer.runningSince = Date.now();
    state.timer.savedAt = Date.now();
    saveTimer();
    $('#focusIndicator').classList.add('active');
    $('#statusText').textContent = 'Focus session active';
    const btn = $('#focusToggleBtn'); if (btn) btn.textContent = '‚èπ Stop Focus';
    if (!_uiInterval) _uiInterval = setInterval(renderTimer, TIMER_INTERVAL);
    if (!_runStartISO) _runStartISO = new Date().toISOString();
  }
  function stopTimer(){
    if (state.timer.runningSince==null) return;
    const now = Date.now();
    const inc = now - state.timer.runningSince;
    state.timer.base = (state.timer.base||0) + inc;
    state.timer.runningSince = null;
    state.timer.savedAt = Date.now();
    saveTimer();
    $('#focusIndicator').classList.remove('active');
    $('#statusText').textContent = 'Monitoring focus‚Ä¶';
    const btn = $('#focusToggleBtn'); if (btn) btn.textContent = 'üéØ Start Focus';

    // Log a session (‚â•1 min) and update minutes counter like before
    if (_runStartISO && inc>=60000) {
      state.focusSessions.push({ start:_runStartISO, end:new Date().toISOString(), durationMs:inc });
      state.totalFocusTime += Math.floor(inc/60000);
      updateProductivity(); updateStats(); save();
    }
    _runStartISO = null;
    renderTimer();
  }
  function toggleFocusSession(){
    if (state.timer.runningSince==null) startTimer(); else stopTimer();
  }
  // keep display fresh on resume
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ state.timer.savedAt=Date.now(); saveTimer(); renderTimer(); }});
  window.addEventListener('beforeunload', ()=>{ state.timer.savedAt = Date.now(); saveTimer(); });
  // Back-compat for your old calls
  function startFocusSession(){ if (state.timer.runningSince==null) toggleFocusSession(); }
  function emergencyRefocus(){ showIntervention('üö® EMERGENCY REFOCUS! Drop everything and focus on what matters most right NOW!'); state.interventions++; updateStats(); save(); }
  // Start rendering
  if (!_uiInterval) _uiInterval = setInterval(renderTimer, TIMER_INTERVAL);
  renderTimer();

  // ---------------- Reminders / Interventions ----------------
  function setFocusReminder(){
    const mins = parseInt(prompt('Remind every how many minutes?','15')); if(!mins) return;
    setInterval(()=> showIntervention(`Focus check! It‚Äôs been ${mins} minutes.`), mins*60*1000);
    showToast(`Reminders every ${mins} min`);
    requestNotifications();
  }
  function quickIntervention(){
    const msgs=['What should you be working on right now?','Are you being productive or just busy?','Stop scrolling. Start doing.','Focus time! What‚Äôs the ONE thing?'];
    showIntervention(msgs[Math.floor(Math.random()*msgs.length)]);
    state.interventions++; updateStats(); save();
  }
  function showIntervention(text){
    $('#interventionMessage').textContent = text;
    openSheet('#interventionPopup');
    $('#currentTask').focus();
  }
  function closeIntervention(){ closeSheet('#interventionPopup'); $('#currentTask').value=''; }
  function commitToTask(){
    const t = $('#currentTask').value.trim(); if(!t){ alert('Enter what you will work on'); return; }
    // start focus if not running
    if (state.timer.runningSince==null) startTimer();
    closeIntervention(); showToast(`Working on: ${t}`);
  }
  function setBreakTimer(){
    closeIntervention(); showToast('5-minute break started');
    setTimeout(()=> showIntervention('Break‚Äôs over! Time to get back to it!'), 5*60*1000);
  }

  // ---------------- Tasks ----------------
  function addTask(){
    const v = $('#taskInput').value.trim(); if(!v) return;
    state.tasks.push({ id:crypto.randomUUID(), title:v, done:false, created:Date.now(), source:'app' });
    $('#taskInput').value=''; renderTasks(); save(); updateStats();
  }
  function toggleTask(id){
    const t = state.tasks.find(x=>x.id===id); if(!t) return;
    t.done=!t.done;
    if(t.done){ t.completedAt = Date.now(); state.tasksCompleted++; }
    renderTasks(); updateStats(); save(); renderWeeklyCompleted(); updateProductivity();
  }
  function toCalendar(id){
    const t = state.tasks.find(x=>x.id===id); if(!t) return; openQuickAdd(t.title);
  }
  function deleteTask(id){
    state.tasks = state.tasks.filter(x=>x.id!==id); renderTasks(); save(); updateStats(); renderWeeklyCompleted(); updateProductivity();
  }
  function renderTasks(){
    const root = $('#taskList'); root.innerHTML='';
    if(state.tasks.length===0){ root.innerHTML='<div class="small" style="padding:8px">No tasks yet.</div>'; return;}
    state.tasks.forEach(t=>{
      const el = document.createElement('div'); el.className='task';
      el.innerHTML = `
        <input type="checkbox" ${t.done?'checked':''} style="width:20px;height:20px" aria-label="Complete" />
        <div class="title" style="${t.done?'text-decoration:line-through;color:#9aa9c4':''}">${t.title}</div>
        <span class="chip">${t.source==='todoist'?'Todoist':'Task'}</span>
        <button class="btn ghost" title="Schedule" aria-label="Add to calendar">üìÖ</button>
        <button class="btn ghost" title="Delete" aria-label="Delete">üóë</button>
      `;
      const [cb,, , btnCal, btnDel] = el.querySelectorAll('input, .title, .chip, button, button');
      cb.addEventListener('change',()=>toggleTask(t.id));
      btnCal.addEventListener('click',()=>toCalendar(t.id));
      btnDel.addEventListener('click',()=>deleteTask(t.id));
      root.appendChild(el);
    });
    $('#statTotalTasks').textContent = state.tasks.length;
  }

  // ---------------- Day Planner ----------------
  const grid = $('#plannerGrid');
  function setDayLabel(){
    const d = state.currentDay;
    const today = new Date(); today.setHours(0,0,0,0);
    const cmp = new Date(d); cmp.setHours(0,0,0,0);
    const same = cmp.getTime()===today.getTime();
    const options={weekday:'short', month:'short', day:'numeric'};
    $('#plannerDayLabel').textContent = (same?'Today ‚Äî ':'') + d.toLocaleDateString([], options);
  }
  function hoursMarkup(){
    let html=''; for(let h=0;h<24;h++){ const lab = (h%12||12)+(h<12?'a':'p'); html+=`<div class="hour" data-hour="${h}" data-h="${lab}"></div>`; }
    grid.innerHTML = html + `<div class="nowline" id="nowLine" style="display:none"></div>`;
  }
  function renderEvents(){
    grid.querySelectorAll('.event').forEach(e=>e.remove());
    const dayKey = dayId(state.currentDay);
    const events = state.events.filter(ev=>ev.day===dayKey);
    events.forEach(ev=> placeEvent(ev));
    const now = new Date(); const show = dayId(now)===dayKey;
    const nl = $('#nowLine'); nl.style.display = show?'block':'none';
    if(show){
      const mins = now.getHours()*60 + now.getMinutes();
      nl.style.top = (mins*56/60) + 'px';
    }
    $('#statTodayEvents').textContent = events.length;
  }
  function placeEvent(ev){
    const startM = ev.start, endM = ev.end;
    const top = startM * 56 / 60;
    const height = Math.max(30, (endM - startM) * 56 / 60);
    const el = document.createElement('div'); el.className='event';
    el.style.top = `${top}px`; el.style.height = `${height}px`;
    el.innerHTML = `
      <div>
        <div>${ev.title}</div>
        <div class="ev-time">${minToLabel(startM)}‚Äì${minToLabel(endM)}</div>
      </div>
      <div>
        <button class="btn ghost" title="Edit" aria-label="Edit">‚úèÔ∏è</button>
        <button class="btn ghost" title="Delete" aria-label="Delete">üóë</button>
      </div>
    `;
    const [editBtn, delBtn] = el.querySelectorAll('button');
    editBtn.addEventListener('click', (e)=>{ e.stopPropagation(); editEvent(ev.id); });
    delBtn.addEventListener('click', (e)=>{ e.stopPropagation(); deleteEvent(ev.id); });
    grid.appendChild(el);
  }
  function minToLabel(m){ const h = Math.floor(m/60), mm = m%60; const ap = h<12?'a':'p'; const hh = h%12||12; return `${hh}:${String(mm).padStart(2,'0')}${ap}`; }
  function labelToMin(val){ const [H,M] = val.split(':').map(n=>+n); return H*60 + M; }

  function dayId(d){ const dt = new Date(d); dt.setHours(0,0,0,0); return dt.toISOString().slice(0,10); }
  function shiftDay(n){ state.currentDay.setDate(state.currentDay.getDate()+n); setDayLabel(); renderWeekStrip(); renderEvents(); }
  function goToday(){ state.currentDay = new Date(); setDayLabel(); renderWeekStrip(); renderEvents(); scrollToNow(); }
  function scrollToNow(){
    const dayKey = dayId(new Date()); if(dayId(state.currentDay)!==dayKey) return;
    const y = (new Date().getHours()*60 + new Date().getMinutes())*56/60 - 140;
    grid.scrollTo({top: Math.max(0,y), behavior:'smooth'});
  }

  function tapHour(e){
    const rect = grid.getBoundingClientRect();
    const y = e.clientY - rect.top + grid.scrollTop;
    const mins = Math.max(0, Math.min(23*60+59, Math.round((y/56)*60/15)*15)); // snap 15m
    openQuickAdd('', mins);
  }

  // Week strip
  function startOfWeek(d){ const x = new Date(d); const day = x.getDay(); x.setHours(0,0,0,0); x.setDate(x.getDate() - day); return x; }
  function sameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
  function renderWeekStrip(){
    const root = $('#weekStrip'); if(!root) return;
    const sow = startOfWeek(state.currentDay);
    const today = new Date();
    let html='';
    for(let i=0;i<7;i++){
      const d = new Date(sow); d.setDate(sow.getDate()+i);
      const lab = d.toLocaleDateString([], { weekday:'short' });
      const num = d.getDate();
      const active = sameDay(d, state.currentDay) ? 'active' : '';
      const todayMark = sameDay(d,today) ? '‚Ä¢' : '';
      html += `<button class="daybtn ${active}" data-d="${d.toISOString()}"><span>${lab}${todayMark?'':''}</span><strong>${num}</strong></button>`;
    }
    root.innerHTML = html;
    root.querySelectorAll('.daybtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        state.currentDay = new Date(btn.getAttribute('data-d'));
        setDayLabel(); renderWeekStrip(); renderEvents(); scrollToNow();
      });
    });
  }

  // Quick Add (new/edit)
  function openQuickAdd(prefillTitle='', startMin=null){
    $('#qa-title-input').value = prefillTitle || '';
    const base = startMin!=null ? startMin : Math.round(((new Date().getHours()*60 + new Date().getMinutes())+7.5)/15)*15;
    const hh = String(Math.floor(base/60)).padStart(2,'0'); const mm = String(base%60).padStart(2,'0');
    $('#qa-start').value = `${hh}:${mm}`;
    openSheet('#quickSheet');
  }
  function saveQuickAdd(){
    const title = $('#qa-title-input').value.trim(); if(!title){ alert('Enter a title'); return; }
    const t = $('#qa-start').value || '09:00';
    const dur = Math.max(15, +($('#qa-dur').value||30));
    const start = labelToMin(t); const end = Math.min(24*60, start+dur);
    const ev = { id:crypto.randomUUID(), title, start, end, day: dayId(state.currentDay) };
    state.events.push(ev); save(); closeQuickAdd(); renderEvents();
  }
  function closeQuickAdd(){ closeSheet('#quickSheet'); }

  function editEvent(evId){
    const ev = state.events.find(e=>e.id===evId); if(!ev) return;
    openQuickAdd(ev.title, ev.start);
    $('#quickSheet').dataset.editId = evId;
    $('#qa-title').textContent = 'Edit Event';
  }
  function deleteEvent(evId){
    state.events = state.events.filter(e=>e.id!==evId); save(); renderEvents();
  }
  const _origSaveQuickAdd = saveQuickAdd;
  saveQuickAdd = function(){
    const editId = $('#quickSheet').dataset.editId;
    const title = $('#qa-title-input').value.trim();
    const t = $('#qa-start').value || '09:00';
    const dur = Math.max(15, +($('#qa-dur').value||30));
    const start = labelToMin(t), end = Math.min(24*60, start+dur);

    if(editId){
      const ev = state.events.find(e=>e.id===editId);
      if(ev){ ev.title=title; ev.start=start; ev.end=end; ev.day=dayId(state.currentDay); }
      $('#quickSheet').dataset.editId = '';
      $('#qa-title').textContent = 'Quick Add';
      closeQuickAdd(); save(); renderEvents(); return;
    }
    const ev = { id:crypto.randomUUID(), title, start, end, day: dayId(state.currentDay) };
    state.events.push(ev); save(); closeQuickAdd(); renderEvents();
  };
  const _origCloseQuickAdd = closeQuickAdd;
  closeQuickAdd = function(){ $('#quickSheet').dataset.editId=''; $('#qa-title').textContent='Quick Add'; _origCloseQuickAdd(); };

  // Sheets
  function openSheet(sel){ const s=$(sel); s.classList.add('open'); s.setAttribute('aria-hidden','false'); }
  function closeSheet(sel){ const s=$(sel); s.classList.remove('open'); s.setAttribute('aria-hidden','true'); }

  // Matrix actions
  function selectQuadrant(q){
    const names=['','DO NOW','SCHEDULE','DELEGATE','ELIMINATE'];
    const tips=['','Urgent & important ‚Äî do it immediately.','Important, not urgent ‚Äî schedule time.','Urgent, not important ‚Äî delegate it.','Not urgent/important ‚Äî remove or limit.'];
    showIntervention(`${names[q]}: ${tips[q]}`);
  }

  // Stats
  function updateStats(){
    $('#focusTime').textContent = state.totalFocusTime;
    $('#interventions').textContent = state.interventions;
    $('#tasksCompleted').textContent = state.tasksCompleted;
  }

  // Network status
  window.addEventListener('online', ()=>{ $('#offlineIndicator').style.display='none'; showToast('Back Online!'); try{ navigator.serviceWorker.ready.then(r=>r.sync.register('focus-data-sync')); }catch{} });
  window.addEventListener('offline', ()=>{ $('#offlineIndicator').style.display='inline-block'; });

  // ---------------- Smarter in-app scroll nudge ----------------
  const NUDGE_STORE_KEY = 'nudgeConfig';
  const NUDGE_CFG = Object.assign(
    { enabled:true, sensitivity:3, cooldownMin:1, cooldownUntil:0 },
    JSON.parse(localStorage.getItem(NUDGE_STORE_KEY) || '{}')
  );
  function sensPreset(level){
    switch(+level){
      case 1: return { windowMs:1200, minEvents:30,  minPx:5000 };
      case 2: return { windowMs:1000, minEvents:18,  minPx:3200 };
      case 3: return { windowMs:900,  minEvents:12,  minPx:2200 };
      case 4: return { windowMs:800,  minEvents:9,   minPx:1500 };
      default:return { windowMs:700,  minEvents:6,   minPx:900  };
    }
  }
  let burst = { startY: 0, px:0, events:0, timer:null, startTs:0, lastScrollY: window.scrollY };
  function resetBurst(){ burst = { startY: window.scrollY, px:0, events:0, timer:null, startTs:0, lastScrollY: window.scrollY }; }
  function maybeNudge(){
    if(!NUDGE_CFG.enabled) return;
    const now = Date.now();
    if(now < (NUDGE_CFG.cooldownUntil||0)) return;
    const { minEvents, minPx } = sensPreset(NUDGE_CFG.sensitivity);
    const deltaDoc = Math.abs(window.scrollY - burst.startY);
    if (burst.events >= minEvents && burst.px >= minPx && deltaDoc >= Math.min(600, window.innerHeight*0.8)) {
      showIntervention('Rapid scrolling detected! Ready to refocus?');
      state.interventions++; updateStats(); save();
      NUDGE_CFG.cooldownUntil = Date.now() + Math.max(0, (NUDGE_CFG.cooldownMin||1)) * 60 * 1000;
      localStorage.setItem(NUDGE_STORE_KEY, JSON.stringify(NUDGE_CFG));
      resetBurst();
    }
  }
  addEventListener('wheel', (e) => {
    if(!NUDGE_CFG.enabled) return;
    const ay = Math.abs(e.deltaY);
    if (ay < 10) return; // ignore tiny jitters
    const { windowMs } = sensPreset(NUDGE_CFG.sensitivity);
    if(!burst.startTs) { burst.startTs = Date.now(); burst.startY = window.scrollY; }
    burst.px += ay; burst.events++;
    clearTimeout(burst.timer);
    burst.timer = setTimeout(()=> { maybeNudge(); resetBurst(); }, windowMs);
  }, { passive:true });

  // Settings sheet
  function openSettings(){
    $('#nudgeEnabled').checked = !!NUDGE_CFG.enabled;
    $('#nudgeSensitivity').value = +NUDGE_CFG.sensitivity || 3;
    $('#nudgeCooldown').value = +NUDGE_CFG.cooldownMin || 1;
    $('#sensLabel').textContent = ` (level ${$('#nudgeSensitivity').value})`;
    $('#cleanMode').checked = (getMode()==='clean');
    openSheet('#settingsSheet');
  }
  function closeSettings(){ closeSheet('#settingsSheet'); }
  $('#nudgeSensitivity')?.addEventListener('input', () => {
    $('#sensLabel').textContent = ` (level ${$('#nudgeSensitivity').value})`;
  });
  function saveSettings(){
    NUDGE_CFG.enabled = $('#nudgeEnabled').checked;
    NUDGE_CFG.sensitivity = +$('#nudgeSensitivity').value;
    NUDGE_CFG.cooldownMin = Math.max(0, +($('#nudgeCooldown').value||0));
    localStorage.setItem(NUDGE_STORE_KEY, JSON.stringify(NUDGE_CFG));
    setMode( $('#cleanMode').checked ? 'clean' : 'full' );
    closeSettings();
  }

  // ---------------- Weekly Completed + Productivity ----------------
  function completedWithinDays(days=7){
    const since = Date.now() - days*24*60*60*1000;
    return state.tasks.filter(t=>t.done && (t.completedAt||0) >= since);
  }
  function renderWeeklyCompleted(){
    const root = $('#weeklyCompletedList'); if(!root) return;
    const list = completedWithinDays(7).sort((a,b)=> (b.completedAt||0)-(a.completedAt||0));
    root.innerHTML = list.length ? list.map(t=>`<li>${t.title}</li>`).join('') : '<li class="small" style="color:#93a5c4">No tasks completed this week</li>';
  }
  function focusHoursLast7(){
    const since = Date.now() - 7*24*60*60*1000;
    const totalMs = state.focusSessions.filter(s=> new Date(s.start).getTime()>=since)
      .reduce((a,s)=> a + (s.durationMs||0), 0);
    return totalMs/3600000;
  }
  function updateProductivity(){
    // Tasks via app (exclude Todoist imports)
    const tasksViaApp = completedWithinDays(7).filter(t=> (t.source||'app') !== 'todoist').length;
    const hours = focusHoursLast7();
    const sessions = state.focusSessions.filter(s => (Date.now()-new Date(s.start).getTime())<=7*24*60*60*1000).length;

    $('#prodTasksViaApp') && ($('#prodTasksViaApp').textContent = String(tasksViaApp));
    $('#prodFocusHours') && ($('#prodFocusHours').textContent = hours.toFixed(1));
    $('#prodSessions') && ($('#prodSessions').textContent = String(sessions));

    // Trend vs previous week
    const now = Date.now(), prevStart = now - 14*24*60*60*1000, prevEnd = now - 7*24*60*60*1000;
    const prevMs = state.focusSessions.filter(s=> {
      const ts = new Date(s.start).getTime();
      return ts>=prevStart && ts<prevEnd;
    }).reduce((a,s)=>a+(s.durationMs||0),0);
    const prevH = prevMs/3600000;
    const delta = hours - prevH;
    const pct = prevH>0 ? Math.round((delta/prevH)*100) : (hours>0?100:0);
    const label = (pct>=0?`+${pct}`:`${pct}`)+'%';
    if($('#prodTrend')) $('#prodTrend').textContent = label;
    if($('#prodTrendBadge')){ const b=$('#prodTrendBadge'); b.textContent=label; b.style.background = pct>=0?'#093a2a':'#3c1420'; b.style.borderColor=pct>=0?'#17644c':'#702a3a'; b.style.color=pct>=0?'#bbf7d0':'#fecaca'; }
    const bar = $('#prodBar'); if(bar){ const w = Math.max(0, Math.min(100, Math.round((hours/10)*100))); bar.style.width = w+'%'; }
  }

  // ---------------- Todoist iCal sync (Cloudflare Worker) ----------------
  const TODOIST_ICS_PROXY = 'https://fi-todoist-ical-proxy.mbps.workers.dev';
  async function fetchTodoistICS(){
    const r = await fetch(TODOIST_ICS_PROXY, { cache:'no-store' });
    if(!r.ok) throw new Error('ICS fetch failed '+r.status);
    return await r.text();
  }
  function parseICS(ics){
    const lines = ics.replace(/\r\n/g,'\n').split('\n');
    const events=[]; let cur=null;
    const commit=()=>{ if(cur){ events.push(cur); cur=null; } };
    for(let i=0;i<lines.length;i++){
      let line=lines[i];
      if(line.startsWith('BEGIN:VEVENT')){ cur={raw:{}}; continue; }
      if(line.startsWith('END:VEVENT')){ commit(); continue; }
      if(!cur) continue;
      while(i+1<lines.length && (lines[i+1].startsWith(' ')||lines[i+1].startsWith('\t'))){ line+=lines[++i].slice(1); }
      const idx=line.indexOf(':'); if(idx===-1) continue;
      const key=line.slice(0,idx).split(';')[0].toUpperCase(), val=line.slice(idx+1);
      cur.raw[key]=val;
    }
    const mapDT=s=>!s?null:(s.length===8?new Date(Date.UTC(+s.slice(0,4),+s.slice(4,6)-1,+s.slice(6,8))):new Date(s.endsWith('Z')?s:s+'Z'));
    return events.map(e=>{
      const uid=(e.raw.UID || `${e.raw.DTSTART||''}-${e.raw.SUMMARY||''}`).trim();
      const summary=(e.raw.SUMMARY||'').trim()||'(untitled)';
      const dtstart=(e.raw.DTSTART||'').trim();
      return { id:String(uid), title:summary, start:mapDT(dtstart) };
    }).filter(e=>e.start);
  }
  async function syncFromTodoistICS(){
    try{
      const ics = await fetchTodoistICS();
      const evs = parseICS(ics);

      // Filter to past week + next 30d for freshness
      const now = Date.now(), minTs=now-7*864e5, maxTs=now+30*864e5;
      const filtered = evs.filter(e=>{ const ts=e.start?.getTime()||0; return ts>=minTs && ts<=maxTs; });

      // Merge as read-only tasks (source:'todoist')
      const map = new Map(state.tasks.map(t=>[String(t.id), t]));
      for(const e of filtered){
        const id = 'tdst:'+e.id;
        if(!map.has(id)){
          map.set(id, { id, title:e.title, done:false, created:e.start.getTime(), source:'todoist' });
        }
      }
      state.tasks = Array.from(map.values());
      save(); renderTasks(); renderWeeklyCompleted(); updateStats(); updateProductivity();
    }catch(err){ console.warn('Todoist iCal sync failed:', err); }
  }

    <script>
    // ---- Clean Mode state/persistence ----
    const MODE_KEY = 'fi_ui_mode'; // 'full' | 'clean'
    function getMode(){ return localStorage.getItem(MODE_KEY) || 'full'; }
    function setMode(m){
      const root = document.documentElement;
      if(m==='clean') root.classList.add('clean'); else root.classList.remove('clean');
      localStorage.setItem(MODE_KEY, m);
      // If hidden view is active, nudge to Tasks
      if(m==='clean' && (state.view==='calendar' || state.view==='stats')) switchView('tasks');
      // Optional header hint
      const status = document.getElementById('statusText');
      if(status) status.textContent = (m==='clean') ? 'Clean Mode ‚Äî minimal & white' : 'Monitoring focus‚Ä¶';
    }
    </script>
  <script>
  // ---------------- Boot ----------------
  function boot(){
    hoursMarkup();
    setDayLabel();
    setMode(getMode());
    renderWeekStrip();
    renderTasks();
    renderEvents();
    renderWeeklyCompleted();
    updateProductivity();
    updateStats();
    setTimeout(scrollToNow, 250);

    const action = new URLSearchParams(location.search).get('action');
    if(action==='focus') setTimeout(quickIntervention, 600);
    else if(action==='start') setTimeout(()=>{ if(state.timer.runningSince==null) startTimer(); }, 600);
    else if(action==='emergency') setTimeout(emergencyRefocus, 400);

    // Move the "now" line every minute
    setInterval(()=>{ if(dayId(new Date())===dayId(state.currentDay)) renderEvents(); }, 60*1000);

    // Gentle reminder every 15m if notifications enabled
    setInterval(()=>{ if(state.notificationsEnabled) showToast('Focus check ‚Äî what are you working on?'); }, 15*60*1000);

    // Ask for notifications the first time
    if('Notification' in window && Notification.permission!=='granted'){
      setTimeout(()=>requestNotifications(), 1200);
    }

    // Keep tasks fresh from Todoist (if online)
    syncFromTodoistICS();
    window.addEventListener('focus', syncFromTodoistICS);
    document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) syncFromTodoistICS(); });
    window.addEventListener('online', syncFromTodoistICS);
    setInterval(syncFromTodoistICS, 5*60*1000);
  }
  document.addEventListener('DOMContentLoaded', boot);

  // Expose for inline handlers (existing)
  window.switchView=switchView;
  window.startFocusSession=startFocusSession; // kept for back-compat
  window.toggleFocusSession=toggleFocusSession; // new
  window.setFocusReminder=setFocusReminder;
  window.quickIntervention=quickIntervention;
  window.emergencyRefocus=emergencyRefocus;
  window.selectQuadrant=selectQuadrant;
  window.addTask=addTask;
  window.openQuickAdd=openQuickAdd;
  window.saveQuickAdd=saveQuickAdd;
  window.closeQuickAdd=closeQuickAdd;
  window.shiftDay=shiftDay;
  window.goToday=goToday;
  window.tapHour=tapHour;
  window.openSettings=openSettings;
  window.closeSettings=closeSettings;
  window.saveSettings=saveSettings;
  </script>
</body>
</html>
